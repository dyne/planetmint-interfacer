# SPDX-License-Identifier: AGPL-3.0-or-later
# Copyright (C) 2022-2023 Dyne.org foundation <foundation@dyne.org>.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

---
- name: Create genesis
  hosts: all
  remote_user: app
  become_user: root
  become_method: sudo
  tasks:
  - name: Remove directory 'identities'
    file:
      path: identities
      state: absent
    delegate_to: localhost
    ignore_errors: yes

  - name: Fetch identities
    fetch:
      src: "/home/app/.tendermint/config/priv_validator_key.json"
      dest: "identities/{{ inventory_hostname }}={{ name }}/key"
      flat: yes

  - name: Fetch IDs
    command: "tendermint show-node-id"
    register: node_id

  - name: Dump IDs to file
    copy:
      content: "{{ node_id.stdout }}"
      dest: "identities/{{ inventory_hostname }}={{ name }}/id"
    delegate_to: localhost

  - name: Join identities
    command: /bin/bash join_identities.sh
    register: identities_out
    delegate_to: localhost
    run_once: true

  - name: Define validators list
    ansible.builtin.set_fact:
      identities: "{{ identities_out.stdout | from_json }}"

  - debug:
      msg: "{{ identities }}"
    delegate_to: localhost
    run_once: true

  - name: Define validators list
    ansible.builtin.set_fact:
      validators: "{{ identities.validators | to_nice_json }}"
      persistent_peers: "{{ identities.persistent_peers | to_nice_json }}"

  - debug:
      msg: "{{ persistent_peers }}"
    delegate_to: localhost
    run_once: true

  - name: Upload tendermint config
    ansible.builtin.template:
      src: testnet/config.yaml.j2
      dest: /home/app/.tendermint/config/config.yaml
      owner: app
      group: app
      mode: '0600'

  - name: Upload genesis file
    ansible.builtin.template:
      src: testnet/genesis.json.j2
      dest: /home/app/.tendermint/config/genesis.json
      owner: app
      group: app
      mode: '0600'
